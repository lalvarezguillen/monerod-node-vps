--- 
- name: Downloads monerod if it doesn't exist or is outdated
  vars:
    - desired_monero_version: '0.17.1.8'
    - monero_download_url: https://downloads.getmonero.org/cli/linux64
    - monero_download_checksum: sha256:b566652c5281970c6137c27dd15002fe6d4c9230bc37d81545b2f36c16e7d476
  block:
    - name: check monerod exists
      stat:
        path: "{{ monerod_path }}"
      register: result_exists

    - name: check monerod version
      command: "{{ monerod_path }} --version"
      register: result_version
      when: "result_exists.stat.exists"
      changed_when: False
      failed_when: False

    - name: install updated monerod
      when: "not result_exists.stat.exists or desired_monero_version not in result_version.stdout"
      block:
        - name: download monerod
          become: True
          get_url:
            url: "{{ monero_download_url }}"
            dest: "{{ monero_dir }}"
            checksum: "{{ monero_download_checksum }}"
            group: "{{ monerod_user }}"
            owner: "{{ monerod_user }}"
            mode: "777"
          register: result_download
        - name: extract monerod
          become: True
          unarchive:
            src: "{{ result_download.dest }}"
            dest: "{{ monero_dir }}"
            group: "{{ monerod_user }}"
            owner: "{{ monerod_user }}"
            mode: "777"
            copy: no
            extra_opts:
              - "--strip-components=1"
        - name: cleanup downloaded artifact
          become: True
          file:
            path: "{{ result_download.dest }}"
            state: absent